<!DOCTYPE html>
<html lang="zh-CN">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="屈秋竹">
    <meta name="description" content="屈秋竹的个人网站">
    <meta name="keywords" content="屈秋竹,秋竹,程序员,站长,工程师,商汤,虎牙,音视频,看见未来">

    <base href="https://quqiuzhu.com/2016/python-requests/">
    <title>
  Requests 源代码浅析 · 看见未来
</title>

    <link rel="canonical" href="https://quqiuzhu.com/2016/python-requests/">

    
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/normalize/8.0.1/normalize.min.css"/>
    
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306475_6bvggoehvvm.css" />

    
    
    <link rel="stylesheet" href="https://quqiuzhu.com/css/coder.min.e7f92773eeff2c735118a3ba44689134642453f82cd54f6f58a8f074a49fe506.css" integrity="sha256-5/knc&#43;7/LHNRGKO6RGiRNGQkU/gs1U9vWKjwdKSf5QY="
      crossorigin="anonymous" media="screen" />

    

    <link rel="icon" type="image/png" href="https://quqiuzhu.com/favicon.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://quqiuzhu.com/favicon.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.64.0-DEV" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://quqiuzhu.com/">
      看见未来
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><span class="iconfont icon-menu"></span></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://quqiuzhu.com/posts/">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://quqiuzhu.com/about/">关于</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Requests 源代码浅析</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <span class="iconfont icon-calendar"></span>
              <time datetime='2016-09-04T10:16:10Z'>
                2016-09-04
              </time>
              &nbsp
              <span class="tags">
  <span class="iconfont icon-tag"></span>
    <a href="https://quqiuzhu.com/tags/python/">python</a>
      <span class="separator">•</span>
    <a href="https://quqiuzhu.com/tags/server/">server</a>
      <span class="separator">•</span>
    <a href="https://quqiuzhu.com/tags/http/">http</a></span>

            </span>
          </div>
        </div>
      </header>

      <div class="post-content">
        <p>Requests是目前最流行的Python HTTP库，使用者众多，包括Amazon, Google, Twitter等大公司和美国国家安全局等政府机构。在<a href="https://github.com/kennethreitz/requests" title="Requests: HTTP for Humans">github</a>上有2w多的star。Requests的接口简单，符合人的直觉而且功能强大。比如持久 Cookie 的会话, Keep-Alive &amp; 连接池,文件分块上传, 流下载, SSL 认证等。其大部分功能由其内置的<a href="https://github.com/shazow/urllib3" title="urllib3">urllib3</a>库实现。所以Requests最关心的不是如何实现协议，而是如何设计接口，正如作者<a href="https://github.com/kennethreitz" title="kennethreitz">github</a>自我介绍，「The only thing I really care about is interface design」。</p>
<!-- raw HTML omitted -->
<h2 id="http基础">HTTP基础</h2>
<h4 id="url">URL</h4>
<p>一个统一资源定位符被分为下面的六段</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">http://user:passwd@httpbin.org:80/basic-auth/user/passwd?name=quqiuzhu#1

&lt;scheme&gt;://&lt;netloc&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;fragment&gt;

&lt;scheme&gt;    http
&lt;netloc&gt;    user:passwd@httpbin.org:80
&lt;path&gt;      basic-auth/user/passwd
&lt;query&gt;     name=quqiuzhu
&lt;fragment&gt;  1
</code></pre></div><p>其中<code>&lt;params&gt;</code>叫做matrix parameters，<code>&lt;query&gt;</code>叫query parameters，<code>&lt;params&gt;</code>支持较少，关于这两种参数的讨论，请看<a href="http://stackoverflow.com/questions/2048121/url-matrix-parameters-vs-request-parameters" title="URL matrix parameters vs. request parameters">stackoverflow</a>。</p>
<p><code>&lt;netloc&gt;</code> 可继续细分为<code>&lt;auth&gt;</code>, <code>&lt;host&gt;</code>, <code>&lt;port&gt;</code>, 一般情况下，没有<code>&lt;auth&gt;</code>部分，和<code>&lt;port&gt;</code>部分。因为在url中明文传递用户名密码和不安全，而且对外提供服务的网站一般都采用默认端口(HTTP:80, HTTPS:443)。</p>
<p><code>&lt;fragment&gt;</code> 通常用作一个网页的页内分段跳转。</p>
<h4 id="http">HTTP</h4>
<p><a href="https://github.com/astaxie/bat" title="bat">bat</a>是一个类似cUrl的API测试工具，执行命令时，其能完整显示整个HTTP协议的传输过程，比如当我对http://httpbin.org/ip做一个GET请求时，其命令为</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">➜  ~ bat http://httpbin.org/ip
</code></pre></div><p>其构造的请求(Request)如下</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">GET /ip HTTP/1.1
Host: httpbin.org
Accept: application/json
Accept-Encoding: gzip, deflate
User-Agent: bat/0.1.0
</code></pre></div><p>第一行是请求行，分别是谓词(方法)、路径和协议版本; 其后跟着的是头部信息(Host、Accept、Accept-Encoding 和User-Agent); 如果是POST或者PUT等请求，还可能会有BODY部分。</p>
<p>回复(Response)的文本如下</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">HTTP/1.1 200 OK
Server : nginx
Date : Sun, 04 Sep 2016 11:59:35 GMT
Content-Type : application/json
Content-Length : 32
Connection : keep-alive
Access-Control-Allow-Origin : *
Access-Control-Allow-Credentials : true


{
  &#34;origin&#34;: &#34;111.0.186.217&#34;
}
</code></pre></div><p>第一行是回复行，分别为协议版本，状态码和状态描述; 其后是头部信息; 之后是空行(<code>\r\n</code>);再后面跟着的是BODY信息。</p>
<p>以上是一个HTTP请求的基本框架，是其他所有功能的基础。</p>
<h2 id="urllib3">urllib3</h2>
<p>Requests大部分HTTP协议功能是urllib3实现的，一直看到最后，会发现urllib3最底层是调用了Python标准库的httplib(Python3 http.client)。它实现下面这些功能</p>
<ul>
<li>Connection pooling</li>
<li>File uploads with multipart encoding</li>
<li>Helpers for retrying requests and dealing with HTTP redirects</li>
<li>Support for gzip and deflate encoding</li>
<li>Proxy support for HTTP and SOCKS</li>
</ul>
<h4 id="连接池">连接池</h4>
<p>urllib3 对外暴露的结构就两个，PoolManager 和 HTTPConnectionPool(HTTPSConnectionPool)。PoolManager管理了一堆的 ConnectionPool，每一个独立的(scheme, host, port)元祖使用同一个ConnectionPool, (scheme, host, port)是从请求的URL中解析出来的。</p>
<p>PoolManager使用自己实现的RecentlyUsedContainer容器来管理ConnectionPool，一旦
ConnectionPool超过限制，则逐出最远使用的ConnectionPool。ConnectionPool内部使用LifoQueue来管理 HTTPConnection，HTTPSConnection和VerifiedHTTPSConnection。XXXXConnection都继承至httplib的httplib.HTTPConnection或者httplib.HTTPSConnection。</p>
<p>典型使用案例</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; http = urllib3.PoolManager(num_pools=50)
&gt;&gt;&gt; r = http.request(&#39;GET&#39;, &#39;http://httpbin.org/ip&#39;)
&gt;&gt;&gt; r.data
&#39;{\n  &#34;origin&#34;: &#34;111.0.186.217&#34;\n}\n&#39;
</code></pre></div><p>同样可以使用 ConnectionPool</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; http = urllib3.HTTPConnectionPool(&#39;httpbin.org&#39;)
&gt;&gt;&gt; r = http.request(&#39;GET&#39;, &#39;http://httpbin.org/ip&#39;)
&gt;&gt;&gt; r.data
&#39;{\n  &#34;origin&#34;: &#34;111.0.186.217&#34;\n}\n&#39;
</code></pre></div><p>PoolManager 与 ConnectionPool有相似的API，是因为它们有共同的父类RequestMethods</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">class RequestMethods(object):
    def urlopen(self, method, url, body=None, headers=None,
                encode_multipart=True, multipart_boundary=None,
                **kw)
    def request(self, method, url, fields=None, headers=None,
                **urlopen_kw)
    ...
</code></pre></div><h4 id="multipart编码文件上传">multipart编码文件上传</h4>
<p>urllib3 中POST, PUT, PATCH等方法，可以使用两种Content-Type上传数据，一种是application/x-www-form-urlencoded，一般用来传递非文件数据，还有一种就是multipart/form-data，可以传输数据也可以传输文件。</p>
<p>使用bat命令查看Content-Type为application/x-www-form-urlencoded的请求</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">➜  ~ bat -f=true http://httpbin.org/post name=qiuzhu age=18
</code></pre></div><p>HTTP请求</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">POST /post HTTP/1.1
Host: httpbin.org
Accept: application/json
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
User-Agent: bat/0.1.0


name=qiuzhu&amp;age=18
</code></pre></div><p>使用bat上传文件，其Content-Type为multipart/form-data的请求</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">➜  ~ bat -f=true http://httpbin.org/post name=qiuzhu f@f.txt
</code></pre></div><p>HTTP请求</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">POST /post HTTP/1.1
Host: httpbin.org
Accept: application/json
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=386e4e1c64f
User-Agent: bat/0.1.0


--386e4e1c64f
Content-Disposition: form-data; name=&#34;f&#34;; filename=&#34;f.txt&#34;
Content-Type: application/octet-stream

text in the f.txt

--386e4e1c64f
Content-Disposition: form-data; name=&#34;name&#34;

qiuzhu
--386e4e1c64f--
</code></pre></div><p>区别在于，application/x-www-form-urlencoded类型的请求会使用urlencode来编码数据，然而multipart/form-data会使用一个边界字符串来区分每一个数据Item，以及请求的起始和结束位置。</p>
<p>filepost模块中的encode_multipart_formdata和fields模块的RequestField都实现了相关功能。使用方式如下</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; file_data = open(&#39;/Users/xshare/Desktop/f.txt&#39;).read()
&gt;&gt;&gt; http = urllib3.PoolManager()
&gt;&gt;&gt; r = http.request(
        &#39;POST&#39;,
        &#39;http://httpbin.org/post&#39;,
        fields={&#39;filefield&#39;: (&#39;f.txt&#39;, file_data)}
)
&gt;&gt;&gt; r.data
</code></pre></div><h4 id="自动跳转-与-gzipdeflate编码">自动跳转 与 gzip/deflate编码</h4>
<p>重试和自动跳转的逻辑很简单，就是检测到重定向状态码(303)之后，重试次数加1，如果超过最大重试次数，则抛出异常。</p>
<p>Retry不仅能实现redirects的计数，而且还有Read和Connect的重试。</p>
<p>自动跳转的逻辑实现在 PoolManager 的 urlopen中，值得注意的是，跳转之后，method为变为GET。</p>
<p>当HTTP Response的Content-Type为gzip/deflate时，对该数据进行编码，使用的库为zlib，这部分的逻辑实现在 response模块的 HTTPResponse中。</p>

      </div>

      <footer>
        <div id="utter-container"></div>
<script src="https://utteranc.es/client.js" repo='quqiuzhu/quqiuzhu.github.io'
    issue-term="title" theme='github-light' crossorigin="anonymous"
    async>
</script>
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
      <p>浙ICP备17015868号</p>
        
     © 2020
    
    
  </section>
</footer>

    </main>

    

<script type="text/javascript" src="https://quqiuzhu.com/bundle.min.71f6cc734ea8c75ac28fd27a49444fac11880210be81de4b7bf8c1a7c59871d5a08807d5b36de3de68282328b61032de05fa94ac41c8ff2c4e3992d18d92ae1b.js" integrity="sha512-cfbMc06ox1rCj9J6SURPrBGIAhC&#43;gd5Le/jBp8WYcdWgiAfVs23j3mgoIyi2EDLeBfqUrEHI/yxOOZLRjZKuGw=="></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-140819128-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



  </body>

</html>
