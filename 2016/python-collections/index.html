<!DOCTYPE html>
<html lang="zh-CN">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="屈秋竹">
    <meta name="description" content="屈秋竹的个人网站">
    <meta name="keywords" content="屈秋竹,秋竹,程序员,站长,工程师,商汤,虎牙,音视频,看见未来">

    <base href="https://quqiuzhu.com/2016/python-collections/">
    <title>
  Python 学习笔记 高性能容器 collections · 看见未来
</title>

    <link rel="canonical" href="https://quqiuzhu.com/2016/python-collections/">

    
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/normalize/8.0.1/normalize.min.css"/>
    
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306475_6bvggoehvvm.css" />

    
    
    <link rel="stylesheet" href="https://quqiuzhu.com/css/coder.min.e7f92773eeff2c735118a3ba44689134642453f82cd54f6f58a8f074a49fe506.css" integrity="sha256-5/knc&#43;7/LHNRGKO6RGiRNGQkU/gs1U9vWKjwdKSf5QY="
      crossorigin="anonymous" media="screen" />

    

    <link rel="icon" type="image/png" href="https://quqiuzhu.com/favicon.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://quqiuzhu.com/favicon.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.86.0" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://quqiuzhu.com/">
      看见未来
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><span class="iconfont icon-menu"></span></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://quqiuzhu.com/posts/">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://quqiuzhu.com/about/">关于</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Python 学习笔记 高性能容器 collections</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <span class="iconfont icon-calendar"></span>
              <time datetime='2016-04-17T20:54:06Z'>
                2016-04-17
              </time>
              &nbsp
              <span class="tags">
  <span class="iconfont icon-tag"></span>
    <a href="https://quqiuzhu.com/tags/python/">python</a></span>

            </span>
          </div>
        </div>
      </header>

      <div class="post-content">
        <p>Python 支持四种内建的集合类型 dict, list, set 和 tuple, 这些类型覆盖了大多数的使用场景。作为补充，collections 提供了几种高性能容器数据类型，Counter, deque, defaultdict 和 OrderedDict，以及 namedtuple() 函数。</p>
<!-- raw HTML omitted -->
<h2 id="counter">Counter</h2>
<p>先不忙讲 Counter 怎么用，先想想如果你来实现一个计数器，应该怎么实现，有哪些功能。我列一下，至少有 3 个功能。</p>
<ol>
<li>接收要统计的数据</li>
<li>更新统计数据</li>
<li>获取统计结果</li>
</ol>
<p>其中 1 和 3 都涉及和 Python 内建类型之间的转换，2 涉及 Counter 之间的交互。</p>
<h4 id="接收要统计的数据">接收要统计的数据</h4>
<p>数据一般是从构造函数传入，参数可以为 iterable 对象，也可以是 mapping 或者关键字参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">c = Counter(<span style="font-style:italic">&#39;quqiuzhu&#39;</span>)
c = Counter({<span style="font-style:italic">&#39;qu&#39;</span>: 1, <span style="font-style:italic">&#39;qiu&#39;</span>: 2, <span style="font-style:italic">&#39;zhu&#39;</span>: 3})
c = Counter(qu=1, qiu=2, zhu=3)
</code></pre></div><p>上面的例子看起来好像是 Counter 里面的 key 必须是字符串类型，value 必须是 int 类型的，实际上并没有这样的限制。比如可以像这样</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">cc = Counter({<span style="font-style:italic">&#39;qu&#39;</span>: 1, 4: 2, <span style="font-style:italic">&#39;zhu&#39;</span>: <span style="font-style:italic">&#39;str&#39;</span>})
</code></pre></div><p>不过在 Counter 之间计算的时候会有一些问题，比如两个 Counter 相加的时候。</p>
<h4 id="更新统计数据">更新统计数据</h4>
<p>单个数据的更新和访问，支持下标访问，如果 Counter 中没有该记录，则返回 0。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">c[<span style="font-style:italic">&#39;quqiuzhu.com&#39;</span>] <span style="font-style:italic"># 0</span>
c[<span style="font-style:italic">&#39;quqiuzhu.com&#39;</span>] = 10 <span style="font-style:italic"># 10</span>
</code></pre></div><p>批量更新有两个方法，<code>subtract([iterable-or-mapping])</code> 和 <code>update([iterable-or-mapping])</code>，参数可以是 iterable, dict, 关键字参数或者 Counter 对象。 <code>subtract</code> 方法对 key 相同的 value 简单的应用减法运算，如果 value 不支持减法运算的话，就会出错，比如上面提到的，value 为 字符串的情况。</p>
<p>Counter 之间也可以进行 +, -, |, &amp; 运算，和你想象中的一样，都是相同 key 的 value 值之间的运算。</p>
<h4 id="获取统计结果">获取统计结果</h4>
<p><code>most_common([n])</code> 获取计数最多的 n 个 (key, value)的列表，<code>items()</code> 返回所有的，<code>elements()</code> 获取统计计数大于等于 2 的。</p>
<p>可以使用 set, list, dict 转为相应类型。</p>
<h2 id="deque">deque</h2>
<p>实现了双端队列的 API, 当队列为定长队列时，如果队列 isFull，则丢弃另一端的 items。</p>
<ul>
<li>append(x)</li>
<li>appendleft(x)</li>
<li>extend(iterable)</li>
<li>extendleft(iterable) 其中 iterable item 顺序会反过来</li>
<li>pop()</li>
<li>popleft()</li>
<li>clear()</li>
<li>count(x)</li>
<li>remove(x)</li>
<li>reverse() 原地反转, 返回None</li>
<li>rotate(n)</li>
</ul>
<p>支持随机访问，但性能不是很好。有只读属性 maxlen, 支持函数操作 len(d), reversed(d), copy.copy(d), copy.deepcopy(d)</p>
<h2 id="defaultdict-与-ordereddict">defaultdict 与 OrderedDict</h2>
<p>该结构扩展自内建类型 dict 。给所有新的 key 一个默认值，该默认值来自于参数 default_factory。
用法如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">d = defaultdict(list)
d[<span style="font-style:italic">&#39;k&#39;</span>] <span style="font-style:italic"># []</span>
</code></pre></div><p>由于当前没有 key &lsquo;k&rsquo;, 所以 defaultdict 调用 default_factory 函数，创建了一个默认值。 这里的 default_factory 是 list 函数。</p>
<p>OrderedDict items 是按照顺序存放的，用来做相等性检测是很好的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">d = {<span style="font-style:italic">&#39;banana&#39;</span>: 3, <span style="font-style:italic">&#39;apple&#39;</span>:4, <span style="font-style:italic">&#39;pear&#39;</span>: 1, <span style="font-style:italic">&#39;orange&#39;</span>: 2}
OrderedDict(sorted(d.items(), key=<span style="font-weight:bold">lambda</span> t: t[0]))
</code></pre></div><p>可以指定排序函数</p>
<h2 id="namedtuple">namedtuple()</h2>
<p>这是非常经典，非常有意思的一个函数，其简单用法如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Point = namedtuple(<span style="font-style:italic">&#39;Point&#39;</span>, [<span style="font-style:italic">&#39;x&#39;</span>, <span style="font-style:italic">&#39;y&#39;</span>])
</code></pre></div><p>这个 Point 是一个类，该类增强了内建的 tuple 类型。 使其支持一般的 tuple操作，也同时支持名称访问，上面的代码，其实现为</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="font-weight:bold">class</span> <span style="font-weight:bold">Point</span>(tuple):
    <span style="font-style:italic">&#39;Point(x, y)&#39;</span>

    __slots__ = ()

    _fields = (<span style="font-style:italic">&#39;x&#39;</span>, <span style="font-style:italic">&#39;y&#39;</span>)

    <span style="font-weight:bold">def</span> __new__(_cls, x, y):
        <span style="font-style:italic">&#39;Create a new instance of Point(x, y)&#39;</span>
        <span style="font-weight:bold">return</span> _tuple.__new__(_cls, (x, y))

    @classmethod
    <span style="font-weight:bold">def</span> _make(cls, iterable, new=tuple.__new__, len=len):
        <span style="font-style:italic">&#39;Make a new Point object from a sequence or iterable&#39;</span>
        result = new(cls, iterable)
        <span style="font-weight:bold">if</span> len(result) != 2:
            <span style="font-weight:bold">raise</span> <span style="font-weight:bold">TypeError</span>(<span style="font-style:italic">&#39;Expected 2 arguments, got </span><span style="font-weight:bold;font-style:italic">%d</span><span style="font-style:italic">&#39;</span> % len(result))
        <span style="font-weight:bold">return</span> result

    <span style="font-weight:bold">def</span> __repr__(self):
        <span style="font-style:italic">&#39;Return a nicely formatted representation string&#39;</span>
        <span style="font-weight:bold">return</span> <span style="font-style:italic">&#39;Point(x=</span><span style="font-weight:bold;font-style:italic">%r</span><span style="font-style:italic">, y=</span><span style="font-weight:bold;font-style:italic">%r</span><span style="font-style:italic">)&#39;</span> % self

    <span style="font-weight:bold">def</span> _asdict(self):
        <span style="font-style:italic">&#39;Return a new OrderedDict which maps field names to their values&#39;</span>
        <span style="font-weight:bold">return</span> OrderedDict(zip(self._fields, self))

    <span style="font-weight:bold">def</span> _replace(_self, **kwds):
        <span style="font-style:italic">&#39;Return a new Point object replacing specified fields with new values&#39;</span>
        result = _self._make(map(kwds.pop, (<span style="font-style:italic">&#39;x&#39;</span>, <span style="font-style:italic">&#39;y&#39;</span>), _self))
        <span style="font-weight:bold">if</span> kwds:
            <span style="font-weight:bold">raise</span> <span style="font-weight:bold">ValueError</span>(<span style="font-style:italic">&#39;Got unexpected field names: </span><span style="font-weight:bold;font-style:italic">%r</span><span style="font-style:italic">&#39;</span> % kwds.keys())
        <span style="font-weight:bold">return</span> result

    <span style="font-weight:bold">def</span> __getnewargs__(self):
        <span style="font-style:italic">&#39;Return self as a plain tuple.   Used by copy and pickle.&#39;</span>
        <span style="font-weight:bold">return</span> tuple(self)

    __dict__ = _property(_asdict)

    <span style="font-weight:bold">def</span> __getstate__(self):
        <span style="font-style:italic">&#39;Exclude the OrderedDict from pickling&#39;</span>
        <span style="font-weight:bold">pass</span>

    x = _property(_itemgetter(0), doc=<span style="font-style:italic">&#39;Alias for field number 0&#39;</span>)

    y = _property(_itemgetter(1), doc=<span style="font-style:italic">&#39;Alias for field number 1&#39;</span>)
</code></pre></div><p>其内部实现为 String 定义模板加上 <code>exec class_definition in namespace</code> 来实现。有兴趣的可以查看其源代码。</p>
<p>新建一个 namedtuple 条目</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">p = Point(11, 22)
p.x <span style="font-style:italic"># 11</span>
</code></pre></div><p>总结以上，其 API 列表为</p>
<ul>
<li>somenamedtuple._make(iterable)</li>
<li>somenamedtuple._asdict()</li>
<li>somenamedtuple._replace(kwargs)</li>
</ul>
<h2 id="abc-集合抽象基类">ABC 集合抽象基类</h2>
<p>下面的表格摘自 <a href="https://docs.python.org/2/library/collections.html">Python 官方文档</a></p>
<p><img src="http://quqiuzhu.com/images/python_abc.png" alt=""></p>

      </div>

      <footer>
        <div id="utter-container"></div>
<script src="https://utteranc.es/client.js" repo='quqiuzhu/quqiuzhu.github.io'
    issue-term="title" theme='github-light' crossorigin="anonymous"
    async>
</script>
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    <p> <a href="https://beian.miit.gov.cn">浙ICP备17015868号-1</a> </p>
        
     © 2023
    
    
  </section>
</footer>

    </main>

    

<script type="text/javascript" src="https://quqiuzhu.com/bundle.min.6e69e85dd5983e29ee3d3d981c3008270531c7faad47072b266d46db0e44b49357be605190a1c26ee07cbcb22afda651ae35f605c9187cb42bc3c047b3b226d4.js" integrity="sha512-bmnoXdWYPinuPT2YHDAIJwUxx/qtRwcrJm1G2w5EtJNXvmBRkKHCbuB8vLIq/aZRrjX2BckYfLQrw8BHs7Im1A=="></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-140819128-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  </body>

</html>
